<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRAFT INFO</title>
  <style>
    :root{
      --bg:#f5f7fb; --panel:#ffffff; --border:#e5e7eb; --text:#111827;
      --muted:#6b7280; --title:#0f172a; --radius:12px;
      --shadow:0 2px 10px rgba(0,0,0,.06); --gap:16px; --side-w:260px; --mid-w: 560px;
      --blue:#2563eb; --red:#e11d48; --sel-ring: rgba(59,130,246,.18);
      --icon:28px; --container-w:500px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
      line-height:1.5;
    }
    .app-header{padding:24px 20px;font-size:28px;font-weight:800;letter-spacing:.5px;color:var(--title);max-width:var(--container-w);margin:0 auto 8px;}

    .app{ max-width:var(--container-w);margin:0 auto 12px;padding:0 20px 8px;display:grid;
      grid-template-columns: 1fr; gap:var(--gap);
    }
    .panel{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);min-height:400px;display:flex;flex-direction:column;overflow:hidden;
    }

    .panel__title{
      height:46px; padding:0 12px;
      border-bottom:1px solid #e2e8f0;
      font-weight:700; background:#f3f4f6;
      display:flex; align-items:center; gap:10px;
    }
    .panel__title .title-text{flex:0 0 auto;}
    .panel__title .title-right{margin-left:auto;display:flex;align-items:center;gap:8px;min-width:0;overflow:visible;}

    .panel__body{padding:16px;color:var(--muted);min-width:0;}
    @media (max-width:900px){ .app{grid-template-columns:1fr;} }

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .panel__footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--border);background:#fff;}

    .input-row{display:flex;gap:8px;}
    .input{flex:1 1 auto;min-width:0;height:36px;padding:0 10px;border:1px solid var(--border);border-radius:8px;font-size:14px;}
    .btn{flex:0 0 auto;height:36px;padding:0 14px;border:1px solid var(--blue);background:var(--blue);color:#fff;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;text-align:center;}
    .btn-outline{border:1px solid var(--red);background:#fff;color:var(--red);height:30px;padding:0 10px;border-radius:8px;cursor:pointer;flex:0 0 auto;white-space:nowrap;}

    .player-empty{color:var(--muted);font-size:14px;}
    .player-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;}
    .player-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;color:#111827;cursor:pointer;}
    .player-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1 1 auto;min-width:0;font-size:14px;font-weight:600;}
    .player-item.selected{border-color:#93c5fd;box-shadow:0 0 0 3px var(--sel-ring);}

    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;}
    .list{display:flex;flex-direction:column;gap:8px;}
    .card{min-width:0;display:flex;align-items:center;gap:8px;padding:4px 4px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;white-space:nowrap;transition:background .15s,border-color .15s,box-shadow .15s;}
    .card:hover{background:#f3f4f6;border-color:#d1d5db;}
    .card img{width:var(--icon);height:var(--icon);object-fit:contain;flex-shrink:0;}
    .card .info{font-size:12px;line-height:1.25;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1 1 auto;min-width:0;}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid #d1d5db;background:#fff;font-size:11px;color:#334155}

    .card.selected{ border-color:#93c5fd; box-shadow:0 0 0 3px var(--sel-ring); background:#eef6ff; }

    .card.checked .info{ color:#9aa3af; text-decoration:line-through; }
    .card.checked{ background:#f1f5f9; border-color:#d1d5db; opacity:.85; }

    .chip{display:flex; align-items:center; gap:8px; padding:4px 8px;
      border:1px solid var(--border); border-radius:8px; background:#f9fafb;white-space:nowrap;}
    .chip img{width:var(--icon);height:var(--icon);object-fit:contain;}
    .chip .name{font-size:12px;white-space:nowrap;line-height: 1.25;}

    .qty-wrap{display:flex; align-items:center; gap:6px; white-space:nowrap;}
    .qty-label{font-size:12px; color:#475569; white-space:nowrap;}
    .qty-field{width:60px; height:28px; font-size:14px; padding:0 6px;
      border:1px solid var(--border); border-radius:6px; background:#fff;
      outline:none; transition:border-color .15s, box-shadow .15s, background .15s;}
    .qty-field[readonly]{ background:#f8fafc; cursor:text; }
    .qty-field:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px var(--sel-ring); }

    .muted{color:#6b7280}
    .small-note{font-size:12px;color:#6b7280;white-space:nowrap;}

    .need-static .card{cursor:default;}
    .need-static .card:hover{background:#f9fafb;border-color:var(--border);}
    /* 제품(완제품) 카드만 더 작게 - 폭 절약 */
  .grid .card{ gap:6px; padding:4px 6px; }
  .grid .card img{ width:24px; height:24px; }
  .grid .card .info{ font-size:11px; }
  .panel.collapsed{min-height:auto;}
  .panel.collapsed .panel__body, .panel.collapsed .panel__footer{display:none;}
  .btn-link{border:none;background:transparent;color:var(--blue);font-weight:700;cursor:pointer;padding:0 6px;height:28px;}
  .chip-mini{display:flex;align-items:center;gap:6px;font-size:12px;color:#64748b;white-space:nowrap;} .chip-mini img{width:18px;height:18px;object-fit:contain;flex-shrink:0;}
  /* ===== Footer (제작자 표시) ===== */
  .app-footer{max-width:var(--container-w);margin:8px auto 24px;padding:8px 12px;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;color:#475569;font-size:12px;text-align:center;}
  .credit-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);background:#fff;border-radius:9999px;font-weight:700;color:#334155;}
  #needPanel .panel__title{display:none;}
  /* 미선택 안내: 심플 버전 */
  .empty-state{display:flex;align-items:center;gap:10px;padding:8px 0;}
  .empty-state .emoji{font-size:18px;}
  .empty-state .msg{font-size:18px;font-weight:800;color:#0f172a;}
</style>
</head>
<body>
  <header class="app-header">CRAFT INFO</header>
  <main class="app">
    <section class="panel collapsed" id="playerPanel" aria-labelledby="player-title">
      <div class="panel__title" id="player-title"><span class="title-text">플레이어</span><span class="title-right" id="playerTitleRight"></span></div>
      <div class="panel__body">
        <div id="playerListContainer">
          <p class="player-empty" id="playerEmpty">플레이어가 없습니다. 아래에서 추가해 주세요.</p>
          <ul class="player-list" id="playerList" hidden></ul>
        </div>
      </div>
      <div class="panel__footer">
        <label for="player-name" class="sr-only">플레이어 이름</label>
        <div class="input-row">
          <input id="player-name" type="text" placeholder="플레이어명" class="input"/>
          <button type="button" class="btn">추가</button>
        </div>
      </div>
    </section>

    <section class="panel collapsed" id="productPanel" aria-labelledby="product-title">
      <div class="panel__title" id="product-title">
        <span class="title-text">완제품</span>
        <span class="title-right" id="productTitleRight"></span>
      </div>
      <div class="panel__body">
        <div class="grid" id="productGrid"></div>
      </div>
    </section>

    <section class="panel" id="needPanel" aria-labelledby="need-title">
      <div class="panel__title" id="need-title">
        <span class="title-text">필요재료</span>
        <span class="title-right" id="needTitleRight"></span>
      </div>
      <div class="panel__body">
        <div id="needBox"></div>
      </div>
    </section>
  </main>
<footer class="app-footer">
  <span class="credit-chip">✍️ 만든이: DanDan</span>
  <span class="credit-chip">🖥️ 서버: 북두의 태권</span>
</footer>
  <script>
  /* ===== 데이터 ===== */
  const PRODUCTS = [
    "STR 보석 II","AGI 보석 II","INT 보석 II","VIT 보석 II","LUK 보석 II","DEX 보석 II",
    "액세서리 축복의 돌 I","방어구 축복의 돌 I","무기 축복의 돌 I",
    "액세서리 보호석 I","방어구 보호석 I","무기 보호석 I",
    "액세서리 기도석","방어구 기도석","무기 기도석"
  ];
  const RECIPES = [
    { product:"STR 보석 II", materials:[ {name:"순수한 보석 광석 Lv.2",qty:30},{name:"채찍 물고기",qty:12} ] },
    { product:"AGI 보석 II", materials:[ {name:"혼돈의 보석 광석 Lv.2",qty:30},{name:"톱니 비늘 물고기",qty:12} ] },
    { product:"INT 보석 II", materials:[ {name:"순수한 보석 광석 Lv.2",qty:30},{name:"무지개 산호",qty:12} ] },
    { product:"VIT 보석 II", materials:[ {name:"혼돈의 보석 광석 Lv.2",qty:30},{name:"채찍 물고기",qty:12} ] },
    { product:"LUK 보석 II", materials:[ {name:"순수한 보석 광석 Lv.2",qty:30},{name:"톱니 비늘 물고기",qty:12} ] },
    { product:"DEX 보석 II", materials:[ {name:"혼돈의 보석 광석 Lv.2",qty:30},{name:"무지개 산호",qty:12} ] },
    { product:"액세서리 축복의 돌 I", materials:[ {name:"축복받은 광석 Lv.1",qty:7},{name:"메이플 피쉬",qty:6} ] },
    { product:"방어구 축복의 돌 I",   materials:[ {name:"축복받은 광석 Lv.1",qty:7},{name:"탄사어",qty:6} ] },
    { product:"무기 축복의 돌 I",     materials:[ {name:"축복받은 광석 Lv.1",qty:7},{name:"비단 해파리",qty:6} ] },
    { product:"액세서리 보호석 I", materials:[ {name:"순수한 보석 광석 Lv.1",qty:36},{name:"혼돈의 보석 광석 Lv.1",qty:36} ] },
    { product:"방어구 보호석 I",   materials:[ {name:"축복받은 광석 Lv.1",qty:6},{name:"혼돈의 보석 광석 Lv.1",qty:41} ] },
    { product:"무기 보호석 I",     materials:[ {name:"축복받은 광석 Lv.1",qty:6},{name:"순수한 보석 광석 Lv.1",qty:41} ] },
    { product:"액세서리 기도석", materials:[ {name:"액세서리 보호석 I",qty:1},{name:"액세서리 축복의 돌 I",qty:1},{name:"달빛의 보석 광석",qty:1},{name:"어린 장수경",qty:1} ] },
    { product:"방어구 기도석",   materials:[ {name:"방어구 보호석 I",qty:1},{name:"방어구 축복의 돌 I",qty:1},{name:"별빛의 보석 광석",qty:1},{name:"은린어",qty:1} ] },
    { product:"무기 기도석",     materials:[ {name:"무기 보호석 I",qty:1},{name:"무기 축복의 돌 I",qty:1},{name:"태양의 보석 광석",qty:1},{name:"홍메치",qty:1} ] },
    { product:"메이플 피쉬", materials:[ {name:"안내초",qty:1} ] },
    { product:"탄사어", materials:[ {name:"바위 버섯",qty:1} ] },
    { product:"비단 해파리", materials:[ {name:"부근초",qty:1} ] }
  ];

  const DEFAULT_QTY = {};
  const RecipeMap = Object.fromEntries(RECIPES.map(r=>[r.product,r.materials]));

  /* ===== 상태/스토리지 ===== */
  window.AppState={
    players:[],nextId:1,selectedPlayerId:null,selectedProduct:null,
    playerSelections:{},playerProductQty:{},playerChecked:{},currentTree:null
  };
  const KEY_PLAYERS='craftinfo.players';
  const KEY_LAST_PLAYER='craftinfo.lastPlayerId';
  const KEY_PLAYER_SELECTIONS='craftinfo.playerSelections';
  const KEY_PLAYER_PRODUCT_QTY='craftinfo.playerProductQty';
  const KEY_PLAYER_CHECKED='craftinfo.playerChecked';

  const savePlayers=()=>localStorage.setItem(KEY_PLAYERS,JSON.stringify(AppState.players));
  const saveLastPlayer=()=>localStorage.setItem(KEY_LAST_PLAYER,JSON.stringify(AppState.selectedPlayerId));
  const savePlayerSelections=()=>localStorage.setItem(KEY_PLAYER_SELECTIONS,JSON.stringify(AppState.playerSelections));
  const savePlayerProductQty=()=>localStorage.setItem(KEY_PLAYER_PRODUCT_QTY,JSON.stringify(AppState.playerProductQty));
  const savePlayerChecked=()=>localStorage.setItem(KEY_PLAYER_CHECKED,JSON.stringify(AppState.playerChecked));

  function loadAll(){try{
    AppState.players=JSON.parse(localStorage.getItem(KEY_PLAYERS)??'[]');
    AppState.nextId=AppState.players.length?Math.max(...AppState.players.map(p=>p.id))+1:1;
    const last=JSON.parse(localStorage.getItem(KEY_LAST_PLAYER)??'null');
    if(typeof last==='number') AppState.selectedPlayerId=last;
    AppState.playerSelections=JSON.parse(localStorage.getItem(KEY_PLAYER_SELECTIONS)??'{}')||{};
    AppState.playerProductQty=JSON.parse(localStorage.getItem(KEY_PLAYER_PRODUCT_QTY)??'{}')||{};
    AppState.playerChecked=JSON.parse(localStorage.getItem(KEY_PLAYER_CHECKED)??'{}')||{};
  }catch(e){console.warn('로드 실패',e)}}

  function getQtyForPlayerProduct(playerId,productName){
    const stored=AppState.playerProductQty[playerId]?.[productName];
    if(stored!=null) return Math.max(0,parseInt(stored,10)||0);
    const def=DEFAULT_QTY[productName];
    return Math.max(0,parseInt(def??1,10)||1);
  }
  function setQtyForPlayerProduct(playerId,productName,qty){
    if(playerId==null) return;
    if(!AppState.playerProductQty[playerId]) AppState.playerProductQty[playerId]={};
    AppState.playerProductQty[playerId][productName]=Math.max(0,parseInt(qty??1,10)||1);
    savePlayerProductQty();
  }

  function getCheckedMap(playerId, product){
    if(!AppState.playerChecked[playerId]) AppState.playerChecked[playerId] = {};
    if(!AppState.playerChecked[playerId][product]) AppState.playerChecked[playerId][product] = {};
    return AppState.playerChecked[playerId][product];
  }
  function setChecked(playerId, product, nodeName, value){
    const map = getCheckedMap(playerId, product);
    if(value) map[nodeName] = true; else delete map[nodeName];
    savePlayerChecked();
  }

  /* ===== 플레이어 ===== */
  function renderPlayers(){
    const list=document.getElementById('playerList'),empty=document.getElementById('playerEmpty');
    list.innerHTML='';
    if(!AppState.players.length){empty.hidden=false;list.hidden=true;return;}
    empty.hidden=true;list.hidden=false;
    for(const p of AppState.players){
      const li=document.createElement('li'); li.className='player-item'; li.dataset.id=String(p.id);
      if(AppState.selectedPlayerId===p.id) li.classList.add('selected');
      const name=document.createElement('span'); name.className='player-name'; name.textContent=p.name;
      const del=document.createElement('button'); del.className='btn-outline'; del.textContent='삭제';
      del.addEventListener('click',ev=>{ev.stopPropagation(); removePlayer(p.id);});
      li.addEventListener('click',()=>selectPlayer(p.id));
      li.append(name,del); list.appendChild(li);
    }
  }
  function addPlayer(name){
    const n=(name||'').trim(); if(!n) return;
    AppState.players.push({id:AppState.nextId++,name:n});
    savePlayers(); renderPlayers();
  }
  function removePlayer(id){
    AppState.players=AppState.players.filter(p=>p.id!==id);
    delete AppState.playerSelections[id]; delete AppState.playerProductQty[id]; delete AppState.playerChecked[id];
    savePlayers(); savePlayerSelections(); savePlayerProductQty(); savePlayerChecked();
    if(AppState.selectedPlayerId===id){ AppState.selectedPlayerId=null; saveLastPlayer(); AppState.selectedProduct=null; renderNeedPanel(); loadProducts(); }
    renderPlayers();
  }
  function selectPlayer(id){
    if(!AppState.players.some(p=>p.id===id)) return;
    AppState.selectedPlayerId=id; saveLastPlayer(); renderPlayers();
    const sel=AppState.playerSelections[id];
    if(sel&&sel.name){const q=getQtyForPlayerProduct(id,sel.name); AppState.selectedProduct={name:sel.name,qty:q};}
    else AppState.selectedProduct=null;
    renderNeedPanel(); loadProducts(); updateNeedTitleChip(); updatePlayerTitle(); updateProductTitle();
    // 자동 접기
    UIState.showPlayers=false; setPanelCollapsedById('playerPanel', true);
  }

  /* ===== 제품 목록 ===== */
  function loadProducts(){
    const grid=document.getElementById('productGrid'); grid.innerHTML='';
    if(AppState.selectedPlayerId==null){
      const empty=document.createElement('div'); empty.className='empty-state';
      const emoji=document.createElement('span'); emoji.className='emoji'; emoji.textContent='👤';
      const msg=document.createElement('div'); msg.className='msg'; msg.textContent='캐릭터를 선택해 주세요';
      empty.append(emoji, msg);
      grid.appendChild(empty);
      return;
    }
    const selectedName = AppState.selectedProduct?.name || null;
    for(const line of PRODUCTS){
      const card=document.createElement('div'); card.className='card'; card.dataset.product=line;
      if(selectedName && line===selectedName){ card.classList.add('selected'); }
      const img=document.createElement('img'); img.src='./icon/'+encodeURIComponent(line)+'.png'; img.alt=line;
      const info=document.createElement('span'); info.className='info'; info.textContent=line;
      card.append(img,info);
      card.addEventListener('click',()=>{
        let qty=1; if(AppState.selectedPlayerId!=null) qty=getQtyForPlayerProduct(AppState.selectedPlayerId,line);
        AppState.selectedProduct={name:line,qty};
        if(AppState.selectedPlayerId!=null){ AppState.playerSelections[AppState.selectedPlayerId]={name:line,qty}; savePlayerSelections(); }
        renderNeedPanel(); loadProducts(); updateNeedTitleChip(); updateProductTitle();
        // 자동 접기
        UIState.showProducts=false; setPanelCollapsedById('productPanel', true);
      });
      grid.appendChild(card);
    }
  }

  function renderSelectedInTitle(){ updateProductTitle(); }

  /* ===== 타이틀 칩 ===== */
  function updateNeedTitleChip(){ const host=document.getElementById('needTitleRight'); if(host) host.innerHTML=''; }

  function updatePlayerTitle(){
    const host=document.getElementById('playerTitleRight'); if(!host) return; host.innerHTML='';
    const name=(AppState.players.find(p=>p.id===AppState.selectedPlayerId)||{}).name;
    const chip=document.createElement('span'); chip.className='chip-mini'; chip.textContent = name?`선택: ${name}`:'미선택';
    const btn=document.createElement('button'); btn.className='btn-link'; btn.textContent = name ? '✏️ 변경' : '선택';
    btn.addEventListener('click',()=>{
      UIState.showPlayers=!UIState.showPlayers;
      if(UIState.showPlayers){ UIState.showProducts=false; setPanelCollapsedById('productPanel', true); }
      setPanelCollapsedById('playerPanel', !UIState.showPlayers);
      updatePlayerTitle(); updateProductTitle();
    });
    host.append(chip, btn);
  }

  function updateProductTitle(){
    const host=document.getElementById('productTitleRight'); if(!host) return; host.innerHTML='';
    const name = AppState.selectedProduct?.name;
    if(name){
      const chip=document.createElement('div'); chip.className='chip';
      const img=document.createElement('img'); img.src='./icon/'+encodeURIComponent(name)+'.png'; img.alt=name;
      const nm=document.createElement('span'); nm.className='name'; nm.textContent=name;
      const qtyWrap=document.createElement('div'); qtyWrap.className='qty-wrap';
      const label=document.createElement('span'); label.className='qty-label'; label.textContent='수량';
      const input=document.createElement('input'); input.type='number'; input.min='0'; input.step='1';
      const initialQty = (AppState.selectedProduct?.qty ?? (AppState.selectedPlayerId!=null? getQtyForPlayerProduct(AppState.selectedPlayerId, name):1)) || 1;
      input.value=String(initialQty); input.className='qty-field'; input.readOnly=true;
      const startEdit = ()=>{ input.readOnly=false; input.focus(); input.select(); };
      const commit = ()=>{
        let v = Math.max(0, parseInt(input.value||'0',10)); input.value=String(v); input.readOnly=true;
        if(AppState.selectedPlayerId!=null){ setQtyForPlayerProduct(AppState.selectedPlayerId, name, v); AppState.playerSelections[AppState.selectedPlayerId]={name, qty:v}; savePlayerSelections(); }
        if(AppState.selectedProduct) AppState.selectedProduct.qty=v;
        renderNeedPanel(); updateProductTitle();
      };
      let committed=false;
      input.addEventListener('click', startEdit);
      input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); input.blur(); } else if(e.key==='Escape'){ input.value=String(initialQty); input.readOnly=true; input.blur(); } });
      input.addEventListener('blur', ()=>{ if(committed) return; committed=true; commit(); setTimeout(()=>{committed=false;},0); });
      qtyWrap.append(label,input);
      chip.append(img,nm,qtyWrap);
      host.appendChild(chip);
      const btn=document.createElement('button'); btn.className='btn-link'; btn.textContent = '✏️ 변경';
      btn.addEventListener('click',()=>{
        UIState.showProducts=!UIState.showProducts;
        if(UIState.showProducts){ UIState.showPlayers=false; setPanelCollapsedById('playerPanel', true); }
        setPanelCollapsedById('productPanel', !UIState.showProducts);
        updateProductTitle(); updatePlayerTitle();
      });
      host.appendChild(btn);
    }else{
      const chip=document.createElement('span'); chip.className='chip-mini'; chip.textContent='미선택';
      const btn=document.createElement('button'); btn.className='btn-link'; btn.textContent = UIState.showProducts? '닫기' : '선택';
      btn.addEventListener('click',()=>{
        UIState.showProducts=!UIState.showProducts;
        if(UIState.showProducts){ UIState.showPlayers=false; setPanelCollapsedById('playerPanel', true); }
        setPanelCollapsedById('productPanel', !UIState.showProducts);
        updateProductTitle(); updatePlayerTitle();
      });
      host.append(chip, btn);
    }
  }

  /* ===== 트리 ===== */
  function buildTreeContext(rootProduct){
    const childrenMap = {}; const parentMap = {};
    const visit = (name) => {
      const children = RecipeMap[name] || [];
      childrenMap[name] = children.map(c=>({name:c.name, qty:Math.max(1,parseInt(c.qty??1,10))}));
      for(const c of children){ if(!parentMap[c.name]) parentMap[c.name] = new Set(); parentMap[c.name].add(name); if(!childrenMap[c.name]) visit(c.name); }
    };
    visit(rootProduct); return {childrenMap, parentMap};
  }
  function getAllDescendants(name, childrenMap){ const out = [], stack = [name]; while(stack.length){ const cur = stack.pop(); const ch = childrenMap[cur]||[]; for(const c of ch){ out.push(c.name); stack.push(c.name); } } return out; }
  function areAllChildrenChecked(name, checkedMap, childrenMap){ const ch = childrenMap[name]||[]; if(ch.length===0) return true; return ch.every(c => checkedMap[c.name]); }

  function renderNeedPanel(){
    const box=document.getElementById('needBox'); box.innerHTML=''; const sel=AppState.selectedProduct;
    if(AppState.selectedPlayerId==null){
      const empty=document.createElement('div'); empty.className='empty-state';
      const emoji=document.createElement('span'); emoji.className='emoji'; emoji.textContent='👤';
      const msg=document.createElement('div'); msg.className='msg'; msg.textContent='캐릭터를 선택해 주세요';
      empty.append(emoji, msg);
      box.appendChild(empty);
      return;
    }
    updateNeedTitleChip(); if(!sel){
      const empty=document.createElement('div'); empty.className='empty-state';
      const emoji=document.createElement('span'); emoji.className='emoji'; emoji.textContent='📦';
      const msg=document.createElement('div'); msg.className='msg'; msg.textContent='제품을 선택해 주세요';
      empty.append(emoji, msg);
      box.appendChild(empty);
      return; }
    const ctx = buildTreeContext(sel.name); AppState.currentTree = ctx;
    const list=document.createElement('div'); list.className='list need-static';
    const mats=RecipeMap[sel.name]||[]; if(!mats.length){ const p=document.createElement('p'); p.className='small-note'; p.textContent='레시피가 없습니다. (RECIPES 배열을 추가하세요)'; box.appendChild(p); return; }
    const playerId = AppState.selectedPlayerId; const product = sel.name; const checkedMap = getCheckedMap(playerId??'__noPlayer__', product);
    const toggleWithPropagation = (nodeName, value)=>{
      const {childrenMap, parentMap} = AppState.currentTree; const pid = AppState.selectedPlayerId ?? '__noPlayer__'; const prod = AppState.selectedProduct?.name ?? '';
      setChecked(pid, prod, nodeName, value); const desc = getAllDescendants(nodeName, childrenMap); for(const d of desc) setChecked(pid, prod, d, value);
      const queue = [...(parentMap[nodeName]??[])];
      while(queue.length){ const parent = queue.shift(); if(value){ const all = areAllChildrenChecked(parent, getCheckedMap(pid, prod), childrenMap); if(all){ setChecked(pid, prod, parent, true); } } else { setChecked(pid, prod, parent, false); } for(const pp of (parentMap[parent]??[])) queue.push(pp); }
      renderNeedPanel();
    };
    const renderNode=(nodeName,perEach,multiplier,depth)=>{
      const total=perEach*multiplier; const card=document.createElement('div'); card.className='card'; card.dataset.material=nodeName; card.style.marginLeft=`${Math.min(depth,6)*24}px`; if(checkedMap[nodeName]) card.classList.add('checked');
      const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.checked = !!checkedMap[nodeName]; checkbox.addEventListener('change',()=>toggleWithPropagation(nodeName, checkbox.checked));
      const img=document.createElement('img'); img.src='./icon/'+encodeURIComponent(nodeName)+'.png'; img.alt=nodeName; const info=document.createElement('span'); info.className='info'; info.textContent=nodeName; const badge=document.createElement('span'); badge.className='badge'; badge.textContent=`총 ${total}`;
      card.append(checkbox,img,info,badge); list.appendChild(card);
      const children=RecipeMap[nodeName]; if(children&&children.length){ for(const c of children){ renderNode(c.name, Math.max(1,parseInt(c.qty??1,10)), total, depth+1); } }
    };
    const qty = Math.max(0, parseInt(sel.qty ?? 0, 10)); for(const m of mats){ renderNode(m.name, Math.max(1,parseInt(m.qty??1,10)), qty, 0); }
    box.appendChild(list);
  }

  /* ===== 접이식 UI 상태 ===== */
  window.UIState = { showPlayers:false, showProducts:false };
  function setPanelCollapsedById(id, collapsed){ const el=document.getElementById(id); if(el) el.classList.toggle('collapsed', !!collapsed); }

  /* ===== 초기화 ===== */
  window.addEventListener('DOMContentLoaded', ()=>{
    loadAll(); loadProducts(); renderPlayers();
    setPanelCollapsedById('playerPanel', true); setPanelCollapsedById('productPanel', true);
    updatePlayerTitle(); updateProductTitle();
    if(AppState.selectedPlayerId!=null) selectPlayer(AppState.selectedPlayerId); else { renderSelectedInTitle(); renderNeedPanel(); }
    const input=document.getElementById('player-name'); const addBtn=document.querySelector('.btn');
    addBtn.addEventListener('click',()=>{ addPlayer(input.value); input.value=''; input.focus(); });
    input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ addPlayer(input.value); input.value=''; } });
  });
</script>
</body>
</html>
